# --- GOV Canary: Adaptive Mesh & Purge (klipper-compat) ---
[gcode_macro GOV_CANARY_ADAPTIVE_PREP]
description: "Adaptive mesh + front-quadrant purge, slicer-bounded, gated"
gcode:
  # -------- Params (raw) --------
  {% set xmin_raw = params.X_MIN | default(0) %}
  {% set xmax_raw = params.X_MAX | default(0) %}
  {% set ymin_raw = params.Y_MIN | default(0) %}
  {% set ymax_raw = params.Y_MAX | default(0) %}
  {% set fls_raw  = params.FIRST_LAYER_SPEED | default(50) %}
  {% set flf_raw  = params.FIRST_LAYER_FAN   | default(0) %}
  {% set lh_raw   = params.LAYER_H           | default(0.2) %}
  {% set line_w_raw    = params.LINE_WIDTH   | default(0.6) %}
  {% set flow_mult_raw = params.FLOW_MULT    | default(1.5) %}

  # -------- Casts (explicit) --------
  {% set xmin = xmin_raw | float %}
  {% set xmax = xmax_raw | float %}
  {% set ymin = ymin_raw | float %}
  {% set ymax = ymax_raw | float %}
  {% set fls  = fls_raw  | int %}
  {% set flf  = flf_raw  | int %}
  {% set lh   = lh_raw   | float %}
  {% set line_w    = line_w_raw | float %}
  {% set flow_mult = flow_mult_raw | float %}

  # -------- Geometry & purge height --------
  {% set purge_h = (lh * 1.5) %}
  {% set arc_len = 60.0 %}
  {% set margin  = 1.0 %}
  {% set bed_x = (xmax - xmin) %}
  {% set xmid = (xmin + (bed_x / 2.0)) %}
  {% set half = (arc_len / 2.0) %}
  {% set x0p = (xmid - half) %}
  {% if x0p < (xmin + margin) %}
    {% set x0p = (xmin + margin) %}
  {% endif %}
  {% set x1max = (xmax - margin) %}
  {% set x1p = (x0p + arc_len) %}
  {% if x1p > x1max %}
    {% set x1p = x1max %}
  {% endif %}
  {% set x0 = (x1p - arc_len) %}
  {% set y0 = (ymin + margin) %}
  {% set y1 = (y0 + 1.0) %}

  # -------- Pre-rounded values for safe {â€¦} insertion --------
  {% set xmin_r2 = xmin | round(2) %}
  {% set ymin_r2 = ymin | round(2) %}
  {% set xmax_r2 = xmax | round(2) %}
  {% set ymax_r2 = ymax | round(2) %}
  {% set purge_h_r3 = purge_h | round(3) %}
  {% set len_mm = (x1p - x0) %}
  {% set len_mm_r1 = len_mm | round(1) %}
  {% set x0_r3 = x0 | round(3) %}
  {% set y0_r3 = y0 | round(3) %}
  {% set x1p_r3 = x1p | round(3) %}
  {% set y1_r3 = y1 | round(3) %}
  {% set s_fan = (flf * 2.55) | round(0) | int %}
  {% set feed = (fls * 60) | int %}

  RESPOND MSG="GOV PLAN: BED_MESH_CALIBRATE MESH_MIN={xmin_r2},{ymin_r2} MESH_MAX={xmax_r2},{ymax_r2}"
  RESPOND MSG="GOV PLAN: Purge Z={purge_h_r3}mm - Speed={fls} - Fan%={flf} - Len={len_mm_r1}"

  # -------- Mesh gate (baseline + hydration flag + startup delay >= 2.0s) --------
  {% set gov_mesh = printer.save_variables.variables.gov_default_mesh | default(1) | int %}
  {% set factory_done = printer.save_variables.variables.factory_cal_complete | default(0) | int %}
  {% if factory_done != 1 %}
    RESPOND MSG="DRIFT_ALERT: Factory calibration not confirmed - skipping automated mesh"
  {% elif gov_mesh != 1 %}
    RESPOND MSG="GOV: Mesh hydration gated by gov_default_mesh=0 - skipping BED_MESH_CALIBRATE"
  {% else %}
    RESPOND MSG="GOV: Hydrating mesh after 2.0s delay"
    G4 P2000
    BED_MESH_CLEAR
    BED_MESH_CALIBRATE MESH_MIN={xmin},{ymin} MESH_MAX={xmax},{ymax}
  {% endif %}

  # -------- Purge path setup --------
  {% set segs = 12 %}
  {% set pass_len = (x1p - x0) %}
  {% set area = 3.1415926535 * (1.75 / 2.0) * (1.75 / 2.0) %}
  {% set vol_per_mm = (line_w * purge_h * flow_mult) %}
  {% set e_per_mm = (vol_per_mm / area) %}
  {% set seg_len = (pass_len / segs) %}
  {% set e_seg = (e_per_mm * seg_len) %}
  {% set e_seg_r4 = e_seg | round(4) %}

  SAVE_GCODE_STATE NAME=GOV_ADAPT_PURGE_STATE
  G90
  M83
  G92 E0

  {% if s_fan > 0 %}
    M106 S{s_fan}
  {% else %}
    M107
  {% endif %}

  # Pass 1: forward arc along front quadrant (Y near Y_MIN)
  G1 Z{purge_h_r3} F600
  G1 X{x0_r3} Y{y0_r3} F6000
  {% for i in range(1, segs + 1) %}
    {% set t = (i / segs) %}
    {% set x_cur_r3 = (x0 + (pass_len * t)) | round(3) %}
    {% set y_cur_r3 = (y0 + (4.0 * 0.5 * t * (1.0 - t))) | round(3) %}
    G1 X{x_cur_r3} Y{y_cur_r3} E{e_seg_r4} F{feed}
  {% endfor %}

  # Pass 2: return arc, shifted +1.0mm in Y to maintain spacing
  G1 X{x1p_r3} Y{y1_r3} F6000
  {% for i in range(1, segs + 1) %}
    {% set t2 = (i / segs) %}
    {% set x2_cur_r3 = (x1p - (pass_len * t2)) | round(3) %}
    {% set y2_cur_r3 = (y1 + (4.0 * 0.5 * t2 * (1.0 - t2))) | round(3) %}
    G1 X{x2_cur_r3} Y{y2_cur_r3} E{e_seg_r4} F{feed}
  {% endfor %}

  G1 E-0.6 F1800
  RESTORE_GCODE_STATE NAME=GOV_ADAPT_PURGE_STATE MOVE=1
# --- end GOV Canary ---
