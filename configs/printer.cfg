# S1 
[rotate_logger]
[gcode_arcs]
[display_status]
[exclude_object]
[respond]
[include macros.cfg]
####################################################################################################
#motor part
####################################################################################################
[stepper_a]
step_pin: PD6
dir_pin: !PD11  # motor direction pin,"!PE2" and "PE2" represent different directions
enable_pin: !PD10
microsteps: 16 
rotation_distance: 60 #rotation_distance = <full_steps_per_rotation> * <microsteps> / <steps_per_mm>, 
endstop_pin: ^PD9
#position_endstop: 435 # printer printable height
#arm_length: 385 
homing_speed: 50
homing_retract_dist: 3

[stepper_b]
step_pin: PD15
dir_pin: !PE9  # motor direction pin
enable_pin: !PE8
microsteps: 16
rotation_distance: 60
endstop_pin: ^PE7
#position_endstop: 435
#arm_length: 385

[stepper_c]
step_pin: PE3
dir_pin: !PC5  # motor direction pin
enable_pin: !PA4
microsteps: 16
rotation_distance: 60
endstop_pin: ^PA3
#position_endstop: 435
#arm_length: 385

[extruder]
step_pin: PE0
dir_pin: !PB9
enable_pin: !PE4
microsteps: 16
rotation_distance: 4.5
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PB8
sensor_type: RT 100K 3950
pullup_resistor: 510
sensor_pin: PC2
min_temp: -10 # extruder min temp
max_temp: 370 # extruder max temp
max_extrude_cross_section: 50 # default 0.640
max_extrude_only_distance: 500
pressure_advance: 0.015
self_adaption_pressure_advance: on # 'on' represents 'turning the self-adaption pressure advance on'. 'off' represents 'turning the self-adaption pressure advance off'.
pressure_advance: 0.041
control:pid
pid_Kp: 24.261
pid_Ki: 1.304
pid_Kd: 112.813

[tmc5160 extruder]
cs_pin:PD7
spi_speed:500000
spi_software_sclk_pin:PA6
spi_software_mosi_pin:PA5
spi_software_miso_pin:PC4
sense_resistor: 0.0375
run_current:1.2
hold_current:0.300
stealthchop_threshold: 0

####################################################################################################
#mcu ,pin
####################################################################################################
[mcu]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0
restart_method: command

[heater_fan motherboard_fan]
pin: PB5
heater_temp:50.0

[fan]
pin: PC7
cycle_time: 0.0001
max_power: 0.55

[heater_fan heat_sink_fan] 
pin: PA2
heater_temp: 50.0
shutdown_speed: 0

[heater_bed]
heater_pin: PD5
sensor_pin: PC1
sensor_type: RT 100K 3950
min_temp: -5
max_temp: 140 #hotbed max temp
control:pid
pid_Kp: 42.423
pid_Ki: 1.911
pid_Kd: 235.447

[heater_generic HotBed1]
gcode_id: HB1
heater_pin: PB3
sensor_pin: PC0
sensor_type: RT 100K 3950
min_temp: -5
max_temp: 140 #hotbed max temp
control:pid
pid_Kp: 18.240
pid_Ki: 0.558
pid_Kd: 149.109

[temperature_sensor Armv7 mcu] #the temp of pad
sensor_type: temperature_host
min_temp: -50
max_temp: 100

[temperature_sensor mcu_temp] #the temp of mcu
sensor_type: temperature_mcu
min_temp: -50
max_temp: 100

[input_shaper]
shaper_type_x: zero_zv
shaper_freq_x: 39.8
shaper_type_y: zero_zv
shaper_freq_y: 41.4


[printer]
kinematics: delta
max_velocity: 3000 
max_accel: 40000 
max_accel_to_decel: 6000  
square_corner_velocity: 5 
max_z_velocity: 3000
#delta_radius: 183.3 # delta radius,default is 183.3
print_radius: 165 
minimum_z_position:-5 # min z position nozzle won't go to the position which Z lower the vaule

################################################################################################################
#calibrate and bed_mesh
################################################################################################################
[delta_calibrate]
radius: 145
horizontal_move_z: 10 #This value is related to the lift height of the nozzle during delta_calibrate
Speed: 100

[probe]  
pin: !PD4
x_offset: 0 
y_offset: 0 
z_offset: 0.0 #the distance between nozzle and level switch
speed: 10
samples: 2 #probe one point three times get an average
samples_result: average  
sample_retract_dist: 5
samples_tolerance: 0.05 # precision
samples_tolerance_retries: 5 

[bed_mesh]  
speed: 100
horizontal_move_z: 7 #This value is related to the lift height of the nozzle during bed_mesh
mesh_radius: 156
mesh_origin: 0,0  
round_probe_count: 7 # 7*7
algorithm: bicubic
fade_start: 0.2
fade_end: 0.0
fade_target: 0
#############################################################################################################
#GCODE
#############################################################################################################

# # ğŸ§¬ Mutation Log: M2025-08-18-MISC-J001
# Macro: ZUP
# Author: FLSUN Stock (governance-tagged)
# File Location: FLSUN_S1_Pro_BaseConfig_Cleaned.cfg
# Purpose: Stock macro (governance-tagged)
# Behavior:
#   - Preserved logic
#   - Comments collapsed into governance header
# ğŸ·ï¸ Lifecycle Tag: Active VALIDATED
# ğŸ”’ Governance-tagged; no logic changes
# ğŸ“ Function group: misc
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

[gcode_macro ZUP]
gcode:
    SET_GCODE_OFFSET Z_ADJUST=0.025 MOVE=1

[gcode_macro ZDOWN]
gcode:
    SET_GCODE_OFFSET Z_ADJUST=-0.025 MOVE=1

[gcode_macro bed_level_1]
gcode:
    SET_GCODE_OFFSET Z=0
    M117 BED LEVEL START !
    G28
    M204 S200
    M104 S140
    M140 S60
    {% if printer.extruder.temperature < 140 or printer.extruder.temperature > 150 %}
      M109 S140
    {% endif %}
    {% if printer.heater_bed.temperature < 55 or printer.heater_bed.temperature > 70 %}
      M190 S60
    {% endif %}
    M117 level heating completed!
    delta_calibrate
    G1 X0 Y0 Z50 F4200
    M104 S0
    M140 S0
    G28
    F104 K=level_state V=True
    save_config

[gcode_macro bed_level_2]
gcode:
    G28
    M204 S200
    M104 S140
    M140 S60
    {% if printer.extruder.temperature < 140 or printer.extruder.temperature > 150 %}
      M109 S140
    {% endif %}
    {% if printer.heater_bed.temperature < 55 or printer.heater_bed.temperature > 70 %}
      M190 S60
    {% endif %}
    G1 X0 Y0 Z50 F4200
    bed_mesh_calibrate
    G1 X0 Y0 Z50 F4200
    M104 S0
    M140 S0
    G28
    F104 K=level2_state V=True
    save_config

[gcode_macro UNLOAD_FILAMENT] #unload filament
gcode:
    M117 unload_filament heating completed!
    G91
    G1 E-100 F200
    G90
    SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0
    M117 unload_filament done!

[gcode_macro CLEAN_FILAMENT] #clean filament, Actually, the feeding is 16cm
gcode:
    {% if 'S' in params %}
      {% set speed_factor = printer.gcode_move.speed_factor|float %}
      {% set extrude_factor = printer.gcode_move.extrude_factor|float %}
      {% set temperature = params.S|int %}
      {% if printer.extruder.temperature < temperature - 5 %}
        M109 S{temperature}
      {% endif %}
      M104 S{temperature}

      M117 unload_filament heating completed!
      G91
      M220 S100   # set speed_factor to normal
      M221 S100   # set extrude_factor to normal
      G1 E100 F1000
      G1 E60 F500
      M220 S{speed_factor*100} # recover speed_factor
      M221 S{extrude_factor*100} # recover extrude_factor
      G90
      M400
      SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0
      M117 unload_filament done!
    {% else %}
      M117 CLEAN_FILAMENT need temperaure,like CLEAN_FILAMENT S=240
    {% endif %}

[gcode_macro LOAD_FILAMENT] #load filament
gcode:
    {% if 'S' in params %}
      {% set speed_factor = printer.gcode_move.speed_factor|float %}
      {% set extrude_factor = printer.gcode_move.extrude_factor|float %}
      {% set temperature = params.S|int %}
      {% if printer.extruder.temperature < temperature - 5 %}
        M109 S{temperature}
      {% endif %}
      M104 S{temperature}
      M117 load_filament heating completed!
      G91
      M220 S100    # set speed_factor to normal
      M221 S100    # set extrude_factor to normal
      G1 E40 F800
      G1 E30 F300
      M400
      M220 S{speed_factor*100}  # recover speed_factor
      M221 S{extrude_factor*100}  # recover extrude_factor
      G90
      SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0
      M117 load_filament done!
    {% else %}
      M117 LOAD_FILAMENT need temperaure,like LOAD_FILAMENT S=240
    {% endif %}
    
[gcode_macro M600]
gcode:
    PAUSE
  
[gcode_macro TMC]
gcode:
    DUMP_TMC STEPPER=extruder

[gcode_macro save_time]
gcode:
    {% if printer.save_variables.variables.total_time %}
      {% set print_time = printer.save_variables.variables.total_time %}
    {% else %} 
      {% set print_time = 0 %}
    {% endif %}
    {% set print_time = print_time + printer.print_stats.print_duration/3600 %}
    SAVE_VARIABLE VARIABLE=total_time VALUE={print_time}

[gcode_macro SET_GCODE_OFFSET]  
rename_existing: _SET_GCODE_OFFSET
gcode:
    {% if printer.save_variables.variables.gcode_offsets %}
      {% set offsets = printer.save_variables.variables.gcode_offsets %}
    {% else %} 
      {% set offsets = {'x': None,'y': None,'z': None} %}
    {% endif %}
    
    {% set ns = namespace(offsets={'x': offsets.x,'y': offsets.y,'z': offsets.z}) %}
    
    {%if 'X' in params %}{% set null = ns.offsets.update({'x': params.X}) %}{% endif %}
    {%if 'Y' in params %}{% set null = ns.offsets.update({'y': params.Y}) %}{% endif %}
    {%if 'Z' in params %}{% set null = ns.offsets.update({'z': params.Z}) %}{% endif %}
    {%if 'Z_ADJUST' in params %}
      {%if ns.offsets.z == None %}{% set null = ns.offsets.update({'z': 0}) %}{% endif %}
      {% set null = ns.offsets.update({'z': (ns.offsets.z | float) + (params.Z_ADJUST | float)}) %}
    {% endif %}
    {% if (ns.offsets.z | float) <= 0.1000001 and (ns.offsets.z | float) >= -0.1000001 %}
      _SET_GCODE_OFFSET {% for p in params %}{'%s=%s '% (p, params[p])}{% endfor %}
      SAVE_VARIABLE VARIABLE=gcode_offsets VALUE="{ns.offsets}"
    {% endif %}

[delayed_gcode LOAD_GCODE_OFFSETS]
initial_duration: 3
gcode:  
    {% if printer.save_variables.variables.gcode_offsets %}
      {% set offsets = printer.save_variables.variables.gcode_offsets %}

      _SET_GCODE_OFFSET {% for axis, offset in offsets.items() if offsets[axis] %}{ "%s=%s " % (axis, offset) }{% endfor %}

      { action_respond_info("Loaded gcode offsets from saved variables [%s]" % (offsets)) }
    {% endif %}
    {% if printer.save_temp_variables.variables.level_state %}
      F104 K=level_state V=False
      bed_level_2
    {% endif %}
    {% if printer.save_temp_variables.variables.level2_state %}
      F104 K=level2_state V=False
      M117 bed level done!
    {% endif %}
    {% if printer.save_temp_variables.variables.resonances_state %}
      F104 K=resonances_state V=False
      G28
      M117 Measuring Resonances done!
    {% endif %}
    {% if printer.save_variables.variables.was_interrupted %}
      M117 power loss occur!
    {% endif %}
    SAVE_VARIABLE VARIABLE=plr_flag VALUE=False

[delayed_gcode LOAD_FUNCTION_SWITCH_DELAY]
initial_duration: 1
gcode:  
    LOAD_FUNCTION_SWITCH

[idle_timeout]
gcode:
#   A list of G-Code commands to execute on an idle timeout. See
#   docs/Command_Templates.md for G-Code format. The default is to run
#   "TURN_OFF_HEATERS" and "M84".
    {% if printer.print_stats.state != "paused" %}
      {% if 'heaters' in printer %}
        TURN_OFF_HEATERS
      {% endif %}
    {% endif %}
timeout: 600
#   Idle time (in seconds) to wait before running the above G-Code
#   commands. The default is 600 seconds.

####################################################################################################################################
#PAUSE ,RESUME ,CANCEL_PRINT
####################################################################################################################################
[pause_resume]

# # ğŸ§¬ Mutation Log: M2025-08-18-MISC-J002
# Macro: PAUSE
# Author: FLSUN Stock (governance-tagged)
# File Location: FLSUN_S1_Pro_BaseConfig_Cleaned.cfg
# Purpose: Stock macro (governance-tagged)
# Behavior:
#   - Preserved logic
#   - Comments collapsed into governance header
# ğŸ·ï¸ Lifecycle Tag: Active VALIDATED
# ğŸ”’ Governance-tagged; no logic changes
# ğŸ“ Function group: misc
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

[gcode_macro PAUSE] 
description: Pause the actual running print
rename_existing: PAUSE_BASE
gcode:
    ##### set defaults #####
    {% if printer.print_stats.state == "printing" %}
      # save the current state for power loss
      SAVE_POWER_LOSS_PARAMS
      # set default pause axis
      {% set x = params.X|default(0) %}      #edit to your park position
      {% set y = params.Y|default(-140) %}      #edit to your park position
      {% set z = params.Z|default(10)|float %} #edit to your park position
      {% set e = params.E|default(1) %}        #edit to your retract length
      ##### calculate save lift position #####
      {% set max_z = printer.toolhead.axis_maximum.z|float %}
      {% set homed_z = printer.gcode_move.homing_origin[2]|float %}
      {% set limit_z = (max_z - homed_z)|round(4,'floor') %}
      {% set act_z = printer.toolhead.position.z|float %}
      {% set lift_z = z|abs %}

      ### If the current position is greater than max_z-65, xy is set to 0###
      ### Normally, the max_z-limit_z is around 50mm,now expand 65mm###
      {% if act_z >= limit_z - 65 %}
        {% set x = 0 %}
        {% set y = 0 %}
        {% set toohigh = true %}
      {% else %}
        {% set toohigh = false %}
      {% endif %}

      {% if act_z < (limit_z - lift_z) %}
        {% set z_safe = act_z + lift_z %}
      {% else %}
        {% set z_safe = limit_z %}
      {% endif %}

      {% set fan_speed = printer.fan.speed|float %}
      SET_GCODE_VARIABLE MACRO=PRE_RESUME VARIABLE=fan_speed VALUE={fan_speed}
      ##### end of definitions #####
      PAUSE_BASE
      G91
      {% if printer.extruder.can_extrude|lower == 'true' %}
        G1 E-{e} F2100
      {% else %}
        {action_respond_info("Extruder not hot enough")}
      {% endif %}
      {% if "xyz" in printer.toolhead.homed_axes %}    
        G90
        {% if toohigh == true %}
          G1 X{x} Y{y} z{z_safe} F6000
          M117 Current position is too high,pause and move to X={ x } Y={ y } Z={ z_safe }
        {% else %}
          # Move the Z-axis to a safe height to avoid collision with the bed or other objects 
          G1 z{z_safe} F6000
          # Move the X and Y axes to the specified position
          G1 X{x} Y{y} F6000
          # clear bed_mesh Z fade height
          G1 X{x} Y{y} F6000
          M117 Pause and move to X={ x } Y={ y } Z={ z_safe }
        {% endif %}
      {% else %}
        {action_respond_info("Printer not homed")}
      {% endif %}
      {% set nozzle_temp = printer.extruder.target|float %}
      SET_GCODE_VARIABLE MACRO=PRE_RESUME VARIABLE=nozzle_temp VALUE={nozzle_temp}
      M104 S90
      M106 S0
      M400
    {% endif %}

[gcode_macro _RESUME_PRE_EXTRUDE]
gcode:
    {% set e = params.E|default(1) %}
    G91
    {% if printer.extruder.can_extrude|lower == 'true' %}
      G1 E{e} F2100
    {% else %}
      {action_respond_info("Extruder not hot enough")}
    {% endif %}
    G90
    M400

[gcode_macro PRE_RESUME]  
description: recover some actions before printing
variable_fan_speed: 0
variable_nozzle_temp: 0
gcode:
      M109 S{nozzle_temp}
      {% set e = params.E|default(1) %} #edit to your retract length
      _RESUME_PRE_EXTRUDE E={e}
      SAVE_VARIABLE VARIABLE=was_interrupted VALUE=False
      screen_led_on R=0 O=0 W=1
      {% set fan_speed = fan_speed / printer.fan.max_power * 255 %}
      M106 S{fan_speed}

[gcode_macro RESUME]
description: Resume the actual running print
rename_existing: RESUME_BASE
gcode:
    #### get VELOCITY parameter if specified ####
    {% if 'VELOCITY' in params|upper %}
      {% set get_params = ('VELOCITY=' + params.VELOCITY)  %}
    {%else %}
      {% set get_params = "" %}
    {% endif %}
    ##### end of definitions #####

    F107 {get_params}

###########################################################################################################################
###########################################################################################################################
[virtual_sdcard]
path: ~/printer_data/gcodes
on_error_gcode:
    M106 S0
    TURN_OFF_HEATERS
    SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0
    SET_FAN_SPEED FAN=box_fan SPEED=0

[save_variables]
filename: ~/printer_data/config/save_variables.cfg
tempfile: ~/temp/saved_variables.cfg

[save_temp_variables]
filename: ~/temp/temp_variables.cfg

[resonance_tester]
probe_points:0, 0, 20
accel_chip: adxl345
min_freq: 20
max_freq: 80
accel_per_hz: 300

[adxl345]
cs_pin:PE13
spi_speed: 100000
spi_software_sclk_pin:PE10
spi_software_mosi_pin:PE11
spi_software_miso_pin:PE12
rate:3200

###########################################################################################################################
# M106
###########################################################################################################################
# # ğŸ§¬ Mutation Log: M2025-08-18-MISC-J003
# Macro: M106
# Author: FLSUN Stock (governance-tagged)
# File Location: FLSUN_S1_Pro_BaseConfig_Cleaned.cfg
# Purpose: Stock macro (governance-tagged)
# Behavior:
#   - Preserved logic
#   - Comments collapsed into governance header
# ğŸ·ï¸ Lifecycle Tag: Active VALIDATED
# ğŸ”’ Governance-tagged; no logic changes
# ğŸ“ Function group: misc
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

[gcode_macro M106]
description: fan speed control
rename_existing: M106.1
gcode:
    {% set last_fan_speed = printer.fan.speed|float %}
    {% set max_power = printer.fan.max_power|float %}
    {% set last_fan_value = last_fan_speed/max_power %}
    {% set fan_speed = params.S|default(255)|int %}
    {% if last_fan_value < 0.1 and fan_speed > 100 %}
      M106.1 S60
      SET_GCODE_VARIABLE MACRO=set_fan VARIABLE=fan_speed VALUE={fan_speed}
      UPDATE_DELAYED_GCODE ID=setfan DURATION=2
    {% else %}
      M106.1 S{fan_speed}
    {% endif %}
[gcode_macro set_fan]
variable_fan_speed: 0
gcode:
    M106.1 S{fan_speed}
[delayed_gcode setfan]
initial_duration: 0 #if initial_duration is zero, the delayed gcode won't start by default
gcode:
    set_fan
    UPDATE_DELAYED_GCODE ID=setfan DURATION=0

#[include ADXL345.cfg] # load ADXL345 module ,Uncomment it before using ADXL345

# EXP1 / EXP2 (display) pins
#[board_pins]
#aliases:
    # EXP1 header
#    EXP1_1=PC1, EXP1_3=PA4, EXP1_5=PA6, EXP1_7=PC4, EXP1_9=<GND>,
#    EXP1_2=PC3, EXP1_4=PA5, EXP1_6=PA7, EXP1_8=PC5, EXP1_10=<5V>,
    # EXP2 header
#    EXP2_1=PB14, EXP2_3=PB11, EXP2_5=PB0,  EXP2_7=PC10,  EXP2_9=<GND>,
#    EXP2_2=PB13, EXP2_4=PA15, EXP2_6=PB15, EXP2_8=<RST>, EXP2_10=<NC>


#################################################################
#LED 
#################################################################
[output_pin relay_pin]
pin: PE1
pwm: False
value: 0 # 0 = off ,1 = on

# # ğŸ§¬ Mutation Log: M2025-08-18-MISC-J004
# Macro: relay_on
# Author: FLSUN Stock (governance-tagged)
# File Location: FLSUN_S1_Pro_BaseConfig_Cleaned.cfg
# Purpose: Stock macro (governance-tagged)
# Behavior:
#   - Preserved logic
#   - Comments collapsed into governance header
# ğŸ·ï¸ Lifecycle Tag: Active VALIDATED
# ğŸ”’ Governance-tagged; no logic changes
# ğŸ“ Function group: misc
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

[gcode_macro relay_on]
gcode:
    SET_PIN PIN=relay_pin VALUE=1

[gcode_macro relay_off]
gcode:
    SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0
    SET_PIN PIN=relay_pin VALUE=0

[output_pin box_led]
pin: PC6
pwm: True
value: 1 # 0 = off ,1 = on
cycle_time: 0.0010

# # ğŸ§¬ Mutation Log: M2025-08-18-MISC-J005
# Macro: box_led_on
# Author: FLSUN Stock (governance-tagged)
# File Location: FLSUN_S1_Pro_BaseConfig_Cleaned.cfg
# Purpose: Stock macro (governance-tagged)
# Behavior:
#   - Preserved logic
#   - Comments collapsed into governance header
# ğŸ·ï¸ Lifecycle Tag: Active VALIDATED
# ğŸ”’ Governance-tagged; no logic changes
# ğŸ“ Function group: misc
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

[gcode_macro box_led_on]
gcode:
    SET_PIN PIN=box_led VALUE=1

[gcode_macro box_led_off]
gcode:
    SET_PIN PIN=box_led VALUE=0
  
[output_pin laser]
pin: PA1
pwm: False
value: 0 # 0 = off ,1 = on
#cycle_time: 0.010

# # ğŸ§¬ Mutation Log: M2025-08-18-MISC-J006
# Macro: laser_on
# Author: FLSUN Stock (governance-tagged)
# File Location: FLSUN_S1_Pro_BaseConfig_Cleaned.cfg
# Purpose: Stock macro (governance-tagged)
# Behavior:
#   - Preserved logic
#   - Comments collapsed into governance header
# ğŸ·ï¸ Lifecycle Tag: Active VALIDATED
# ğŸ”’ Governance-tagged; no logic changes
# ğŸ“ Function group: misc
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

[gcode_macro laser_on]
gcode:
    SET_PIN PIN=laser VALUE=1

[gcode_macro laser_off]
gcode:
    SET_PIN PIN=laser VALUE=0
  
[output_pin LED_WHITE]
pin: PA12 
pwm: True
value: 1 # 0 = off ,1 = on
cycle_time: 0.010

[output_pin LED_ORANGE]
pin: PD1
pwm: True
value: 0 # 0 = off ,1 = on
cycle_time: 0.010

[output_pin LED_RED]
pin: PD0
pwm: True
value: 0 # 0 = off ,1 = on
cycle_time: 0.010

# # ğŸ§¬ Mutation Log: M2025-08-18-MISC-J007
# Macro: screen_led_on
# Author: FLSUN Stock (governance-tagged)
# File Location: FLSUN_S1_Pro_BaseConfig_Cleaned.cfg
# Purpose: Stock macro (governance-tagged)
# Behavior:
#   - Preserved logic
#   - Comments collapsed into governance header
# ğŸ·ï¸ Lifecycle Tag: Active VALIDATED
# ğŸ”’ Governance-tagged; no logic changes
# ğŸ“ Function group: misc
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

[gcode_macro screen_led_on]
gcode:
    SET_PIN PIN=LED_RED VALUE={ params.R|default(1) }
    SET_PIN PIN=LED_ORANGE VALUE={ params.O|default(1) }
    SET_PIN PIN=LED_WHITE VALUE={ params.W|default(1) }
  
[gcode_macro screen_led_off]
gcode:
    SET_PIN PIN=LED_RED VALUE=0
    SET_PIN PIN=LED_ORANGE VALUE=0
    SET_PIN PIN=LED_WHITE VALUE=0

######################################################################
#function
######################################################################
[gcode_macro PID_HOTEND]
description: Hotend PID Calibration
gcode:
    {% set HOTEND_TEMP=params.HOTEND_TEMP|default(240)|float %}
    {% if printer.print_stats.state == "Printing" %}
      M117 This macro cannot be used while printing!
    {% else %}
      M117 Hotend PID calibration in progress...
      # SCREEN_LED_ON R=0 O=1 W=0
      SCREEN_LED_ON R=0 O=0 W=1 #20240814 Temporary change
      {% if printer.toolhead.homed_axes != "xyz" %}
        G28
      {% endif %}
      G90
      G1 Z50 F6000
      M400
      M106 S255
      PID_CALIBRATE HEATER=extruder TARGET={HOTEND_TEMP}
      M107
      G28
      SCREEN_LED_ON R=0 O=0 W=1
      M117 Hotend PID calibration finished
      M400
      SAVE_CONFIG
    {% endif %}
  
[gcode_macro PID_BED]
description: Bed PID Calibration
gcode:
    {% set BED_TEMP=params.BED_TEMP|default(60)|float %}
    {% if printer.print_stats.state == "Printing" %}
      M117 This macro cannot be used while printing!
    {% else %}
      M117 BED PID CALIBRATION START!
      # SCREEN_LED_ON R=0 O=1 W=0
      SCREEN_LED_ON R=0 O=0 W=1 #20240814 Temporary change
      {% if printer.toolhead.homed_axes != "xyz" %}
        G28
      {% endif %}
      G90
      G1 Z50 F6000
      M400
      M106 S255
      M117 Start PID Calibration for inner bed...
      PID_CALIBRATE HEATER=heater_bed TARGET={BED_TEMP}
      M117 Start PID Calibration for outer bed...
      PID_CALIBRATE HEATER=HotBed1 TARGET={BED_TEMP}
      M107
      G28
      SCREEN_LED_ON R=0 O=0 W=1
      M117 Bed PID calibration finished
      M400
      SAVE_CONFIG
    {% endif %}

[gcode_macro MEASURING_RESONANCES] #æ£€æµ‹å…±æŒ¯
description: Measuring Resonances
gcode: 
    M117 MEASURING RESONANCES START !
    SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0
    G28
    SHAPER_CALIBRATE
    G28
    F104 K=resonances_state V=True
    SAVE_CONFIG

[gcode_macro TIMELAPSE] #å»¶æ—¶æ‘„å½±
description: Timelapse
gcode: 
    M117 Timelapse done!

[output_pin motor_cali_a]
pin: PD13
pwm: False
value: 0
[output_pin motor_cali_b]
pin: PE15
pwm: False
value: 0
[output_pin motor_cali_c]
pin: PB0
pwm: False
value: 0
[gcode_button motor_a]
pin: PD14
press_gcode: 
release_gcode: 
[gcode_button motor_b]
pin: PD8
press_gcode: 
release_gcode: 
[gcode_button motor_c]
pin: PB1
press_gcode: 
release_gcode: 

# # ğŸ§¬ Mutation Log: M2025-08-18-MISC-J008
# Macro: CLEAN_CALIBRATE_MOTOR
# Author: FLSUN Stock (governance-tagged)
# File Location: FLSUN_S1_Pro_BaseConfig_Cleaned.cfg
# Purpose: Stock macro (governance-tagged)
# Behavior:
#   - Preserved logic
#   - Comments collapsed into governance header
# ğŸ·ï¸ Lifecycle Tag: Active VALIDATED
# ğŸ”’ Governance-tagged; no logic changes
# ğŸ“ Function group: misc
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

[gcode_macro CLEAN_CALIBRATE_MOTOR]
description: clean calibrate motor data
gcode:
    M18
    #æ¸…é™¤æ•°æ®ä¿¡å·
    SET_PIN PIN=motor_cali_a VALUE=0
    #G4 P10
    SET_PIN PIN=motor_cali_b VALUE=0
    #G4 P10
    SET_PIN PIN=motor_cali_c VALUE=0
    G4 P290
    SET_PIN PIN=motor_cali_a VALUE=1
    #G4 P10
    SET_PIN PIN=motor_cali_b VALUE=1
    #G4 P10
    SET_PIN PIN=motor_cali_c VALUE=1
    G4 P290
    SET_PIN PIN=motor_cali_a VALUE=0
    #G4 P10
    SET_PIN PIN=motor_cali_b VALUE=0
    #G4 P10
    SET_PIN PIN=motor_cali_c VALUE=0
    G4 P290
    SET_PIN PIN=motor_cali_a VALUE=1
    #G4 P10
    SET_PIN PIN=motor_cali_b VALUE=1
    #G4 P10
    SET_PIN PIN=motor_cali_c VALUE=1
    G4 P290
    SET_PIN PIN=motor_cali_a VALUE=0
    #G4 P10
    SET_PIN PIN=motor_cali_b VALUE=0
    #G4 P10
    SET_PIN PIN=motor_cali_c VALUE=0
    G4 P290
    SET_PIN PIN=motor_cali_a VALUE=1
    #G4 P10
    SET_PIN PIN=motor_cali_b VALUE=1
    #G4 P10
    SET_PIN PIN=motor_cali_c VALUE=1
    G4 P290
    SET_PIN PIN=motor_cali_a VALUE=0
    #G4 P10
    SET_PIN PIN=motor_cali_b VALUE=0
    #G4 P10
    SET_PIN PIN=motor_cali_c VALUE=0

[gcode_macro CALIBRATE_MOTOR_DATA] #ç”µæœºæ ¡å‡†
description: calibrate motor
gcode: 
    M18
    M17
    M18
    #æ ¡å‡†ä¿¡å·
    SET_PIN PIN=motor_cali_a VALUE=0
    #G4 P10
    SET_PIN PIN=motor_cali_b VALUE=0
    #G4 P10
    SET_PIN PIN=motor_cali_c VALUE=0
    G4 P200
    SET_PIN PIN=motor_cali_c VALUE=1
    #G4 P10
    SET_PIN PIN=motor_cali_a VALUE=1
    #G4 P10
    SET_PIN PIN=motor_cali_b VALUE=1
    G4 P200
    SET_PIN PIN=motor_cali_b VALUE=0
    #G4 P10
    SET_PIN PIN=motor_cali_c VALUE=0
    #G4 P10
    SET_PIN PIN=motor_cali_a VALUE=0
    G4 P200
    SET_PIN PIN=motor_cali_a VALUE=1
    #G4 P10
    SET_PIN PIN=motor_cali_b VALUE=1
    #G4 P10
    SET_PIN PIN=motor_cali_c VALUE=1
    G4 P200
    SET_PIN PIN=motor_cali_c VALUE=0
    #G4 P10
    SET_PIN PIN=motor_cali_a VALUE=0
    #G4 P10
    SET_PIN PIN=motor_cali_b VALUE=0
    G4 P200
    SET_PIN PIN=motor_cali_b VALUE=1
    #G4 P10
    SET_PIN PIN=motor_cali_c VALUE=1
    #G4 P10
    SET_PIN PIN=motor_cali_a VALUE=1
    G4 P200
    SET_PIN PIN=motor_cali_a VALUE=0
    #G4 P10
    SET_PIN PIN=motor_cali_b VALUE=0
    #G4 P10
    SET_PIN PIN=motor_cali_c VALUE=0
    G4 P200
    SET_PIN PIN=motor_cali_c VALUE=1
    #G4 P10
    SET_PIN PIN=motor_cali_a VALUE=1
    #G4 P10
    SET_PIN PIN=motor_cali_b VALUE=1
    G4 P200
    SET_PIN PIN=motor_cali_b VALUE=0
    #G4 P10
    SET_PIN PIN=motor_cali_c VALUE=0
    #G4 P10
    SET_PIN PIN=motor_cali_a VALUE=0
    G4 P200
    SET_PIN PIN=motor_cali_a VALUE=1
    #G4 P10
    SET_PIN PIN=motor_cali_b VALUE=1
    #G4 P10
    SET_PIN PIN=motor_cali_c VALUE=1
    G4 P200
    SET_PIN PIN=motor_cali_c VALUE=0
    #G4 P10
    SET_PIN PIN=motor_cali_a VALUE=0
    #G4 P10
    SET_PIN PIN=motor_cali_b VALUE=0
    M17
    G4 P30000 #æ ¡å‡†æ—¶é—´
    
[gcode_macro CALIBRATE_MOTOR] #ç”µæœºæ ¡å‡†
description: calibrate motor
gcode: 
    G28
    G90
    G1 Z10 F6000
    CLEAN_CALIBRATE_MOTOR
    CALIBRATE_MOTOR_DATA
    M117 motor a is ok!
    M117 motor b is ok!
    M117 motor c is ok!
    G28
    M117 calibrate motor done!

######################################################################
#filament sensor
######################################################################
[filament_switch_sensor filament_sensor] #æ–­æ–™æ£€æµ‹
pause_on_runout: False
#runout_gcode:  # pause when filament runout
insert_gcode: 
    # cancel the pause delay_gcode that will be executed after run 50cm
    SET_GCODE_VARIABLE MACRO=PAUSE_AFTER_D VARIABLE=start VALUE=0
switch_off_gcode:
    # cancel the pause delay_gcode that will be executed after run 50cm
    SET_GCODE_VARIABLE MACRO=PAUSE_AFTER_D VARIABLE=start VALUE=0
switch_pin: PA11

[filament_motion_sensor my_sensor] #å µæ–™æ£€æµ‹
detection_length: 18.0 #è¿™ä¸ªè€—æè·ç¦»ä¹‹å†…ï¼Œå¼€å…³çŠ¶æ€æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œå³è§¦å‘
#   The minimum length of filament pulled through the sensor to trigger
#   a state change on the switch_pin
#   Default is 7 mm.
extruder: extruder
#   The name of the extruder section this sensor is associated with.
#   This parameter must be provided.
switch_pin: PA10
#insert_gcode: RESUME
pause_on_runout: False # This can be set to false to debug false positives putting the sensor in "monitor mode". The printer will not pause but it will run the runout_gcode below. 
#event_delay: 20.0
#pause_delay: 5.0
runout_gcode:
    {% if printer.print_stats.state == "printing" %}
      {% if printer["filament_switch_sensor filament_sensor"].filament_detected %}
        PAUSE
        # screen_led_on R=0 O=1 W=0
        SCREEN_LED_ON R=0 O=0 W=1 #20240814 Temporary change
        M117 Filament Clog Detected!
      {% else %}
        #PAUSE
        PAUSE_AFTER_D D=500
        #M117 Filament Runout Detected!
      {% endif %}
    {% endif %}

# # ğŸ§¬ Mutation Log: M2025-08-18-MISC-J009
# Macro: PAUSE_AFTER_D
# Author: FLSUN Stock (governance-tagged)
# File Location: FLSUN_S1_Pro_BaseConfig_Cleaned.cfg
# Purpose: Stock macro (governance-tagged)
# Behavior:
#   - Preserved logic
#   - Comments collapsed into governance header
# ğŸ·ï¸ Lifecycle Tag: Active VALIDATED
# ğŸ”’ Governance-tagged; no logic changes
# ğŸ“ Function group: misc
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

[gcode_macro PAUSE_AFTER_D]
description: Trigger to pause the print after a further 'd' mm has been extruded
variable_end_d: 0 #create variable "END_D" which is associated with the PAUSE_AFTER_D gcode macro
variable_start: 0
gcode:
    {% if printer["gcode_macro PAUSE_AFTER_D"].start == 0%}
      {% set d_start = printer.print_stats.filament_used|float %} #starting point is whatever the filament used is when PAUSE_AFTER_D is called
      {% set d_end = (d_start + params.D|float)|float %} #end point is start + D parameter
      SET_GCODE_VARIABLE MACRO=PAUSE_AFTER_D VARIABLE=end_d VALUE={d_end} #write the end value to the END_D gcode variable to access later
      M117 Pause at {d_end|round(2)}
      SET_GCODE_VARIABLE MACRO=PAUSE_AFTER_D VARIABLE=start VALUE=1
      UPDATE_DELAYED_GCODE ID=PAUSE_AT_D DURATION=1 #trigger the delayed gcode below after 1 second
    {% endif %}

[delayed_gcode PAUSE_AT_D]
initial_duration: 0 #if initial_duration is zero, the delayed gcode won't start by default
gcode:
    {% if printer["gcode_macro PAUSE_AFTER_D"].start == 0 %}
      UPDATE_DELAYED_GCODE ID=PAUSE_AT_D DURATION=0 
    {% else %}
      {% set d_current = printer.print_stats.filament_used|float %} #get the current filament used
      {% if d_current < printer["gcode_macro PAUSE_AFTER_D"].end_d %} #if we aren't at the stopping point
        M117 Stopping {d_current|round(2)} {printer["gcode_macro PAUSE_AFTER_D"].end_d|round(2)}
        UPDATE_DELAYED_GCODE ID=PAUSE_AT_D DURATION=1 #restart the timer on the delayed gcode
      {% else %}
        PAUSE
        M117 Filament Runout Detected!
        # screen_led_on R=0 O=1 W=0
        SCREEN_LED_ON R=0 O=0 W=1 #20240814 Temporary change
        UPDATE_DELAYED_GCODE ID=PAUSE_AT_D DURATION=0 #set the delayed gcode duration back to zero so it doesn't keep triggering
        SET_GCODE_VARIABLE MACRO=PAUSE_AFTER_D VARIABLE=start VALUE=0
      {% endif %}
    {% endif %}

#######################################################################################
#fan
#######################################################################################
[fan_generic box_fan] #ç®±ä½“é£æ‰‡ SET_FAN_SPEED FAN=box_fan SPEED=     é€Ÿåº¦è¿™é‡Œå¡«0.0~1.0
pin:PB4
#max_power:
#shutdown_speed:
#cycle_time:
#hardware_pwm:
#kick_start_time:
#off_below:
#tachometer_pin:
#tachometer_ppr:
#tachometer_poll_interval:
#enable_pin:
#   See the "fan" section for a description of the above parameters.

[fan_generic drying_box_fan] #ç®±ä½“é£æ‰‡ SET_FAN_SPEED FAN=drying_box_fan SPEED=     é€Ÿåº¦è¿™é‡Œå¡«0.0~1.0
pin:PA8
#max_power:
#shutdown_speed:
#cycle_time:
#hardware_pwm:
#kick_start_time:
#off_below:
#tachometer_pin:
#tachometer_ppr:
#tachometer_poll_interval:
#enable_pin:
#   See the "fan" section for a description of the above parameters.

[output_pin drying_box_heater]
pin: PA9
pwm: True
value: 0 # 0 = off ,1 = on
#cycle_time: 0.010

# # ğŸ§¬ Mutation Log: M2025-08-18-MISC-J010
# Macro: drying_box_off
# Author: FLSUN Stock (governance-tagged)
# File Location: FLSUN_S1_Pro_BaseConfig_Cleaned.cfg
# Purpose: Stock macro (governance-tagged)
# Behavior:
#   - Preserved logic
#   - Comments collapsed into governance header
# ğŸ·ï¸ Lifecycle Tag: Active VALIDATED
# ğŸ”’ Governance-tagged; no logic changes
# ğŸ“ Function group: misc
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

[gcode_macro drying_box_off]
gcode:
    SET_PIN PIN=drying_box_heater VALUE=0
  
[gcode_macro drying_box_1]
gcode:
    SET_PIN PIN=drying_box_heater VALUE=1.0
    
#############################################################################################
#power loss
#############################################################################################
[gcode_macro SHUTDOWN]
gcode:
    {action_call_remote_method("shutdown_machine")}

[gcode_macro SAVE_POWER_LOSS_PARAMS]
gcode:
    {% if printer["filament_switch_sensor power_loss"].enabled %}
      {% set file_position = printer.virtual_sdcard.file_position %} #save file position
      SAVE_VARIABLE VARIABLE=file_position VALUE={file_position}
      {% set absolute_extrude = printer.gcode_move.absolute_extrude %}
      SAVE_VARIABLE VARIABLE=absolute_extrude VALUE={absolute_extrude}
      {% set e_pos = printer.gcode_move.gcode_position.e %}
      SAVE_VARIABLE VARIABLE=e_pos VALUE={e_pos}
      {% set x_pos = printer.gcode_move.gcode_position.x %}
      SAVE_VARIABLE VARIABLE=x_pos VALUE={x_pos}
      {% set y_pos = printer.gcode_move.gcode_position.y %}
      SAVE_VARIABLE VARIABLE=y_pos VALUE={y_pos}
      {% set z_pos = printer.gcode_move.gcode_position.z %}
      SAVE_VARIABLE VARIABLE=z_pos VALUE={z_pos}
      {% set print_duration = printer.print_stats.print_duration %}
      SAVE_VARIABLE VARIABLE=print_duration VALUE={print_duration}
      {% set filament_used = printer.print_stats.filament_used %}
      SAVE_VARIABLE VARIABLE=filament_used VALUE={filament_used}
      {% set fan_speed = printer.fan.speed|float %}
      SAVE_VARIABLE VARIABLE=fan_speed VALUE={fan_speed}
      {% set fan_max_power_factor = printer.fan.max_power_factor|float %}
      SAVE_VARIABLE VARIABLE=fan_max_power_factor VALUE={fan_max_power_factor}
      {% set nozzle_temp = printer.extruder.target|float %}
      SAVE_VARIABLE VARIABLE=nozzle_temp VALUE={nozzle_temp}
      {% set bed_temp = printer.heater_bed.target|float %}
      SAVE_VARIABLE VARIABLE=bed_temp VALUE={bed_temp}
      {% set hotbed1_temp = printer["heater_generic HotBed1"].target|float %}
      SAVE_VARIABLE VARIABLE=hotbed1_temp VALUE={hotbed1_temp}
      SAVE_VARIABLE VARIABLE=was_interrupted VALUE=True
    {% endif %}

[filament_switch_sensor power_loss]  
pause_on_runout: False
switch_pin: PD3
event_delay: 0.01
pause_delay: 0.01
insert_gcode:
    {% if printer.print_stats.state == "printing" %}
      SAVE_POWER_LOSS_PARAMS
      F112
      SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0
      STEPPER_STOP
      SHUTDOWN
      G4 P5000
    {% else %}
      F112
    {% endif %} 
on_disable_gcode:
    {% if printer.print_stats.state == "printing" %}
      F112
      STEPPER_STOP
      SHUTDOWN
      G4 P5000
    {% else %}
      F112
    {% endif %} 

[force_move]
enable_force_move: True

# # ğŸ§¬ Mutation Log: M2025-08-18-MISC-J011
# Macro: RESUME_INTERRUPTED
# Author: FLSUN Stock (governance-tagged)
# File Location: FLSUN_S1_Pro_BaseConfig_Cleaned.cfg
# Purpose: Stock macro (governance-tagged)
# Behavior:
#   - Preserved logic
#   - Comments collapsed into governance header
# ğŸ·ï¸ Lifecycle Tag: Active VALIDATED
# ğŸ”’ Governance-tagged; no logic changes
# ğŸ“ Function group: misc
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

[gcode_macro RESUME_INTERRUPTED]
gcode = 
    {% set file_position = printer.save_variables.variables.file_position %}
    {% set last_file = params.GCODE_FILE|default(printer.save_variables.variables.sd_filename)|string %}
    {% set print_duration = printer.save_variables.variables.print_duration %}
    {% if printer.save_variables.variables.absolute_extrude %}
      M82 # set extrude absolute
    {% else %}
      M83 # set extrude relative
    {% endif%}
    {% set e_pos = printer.save_variables.variables.e_pos %}
    G92 E{e_pos}
    SAVE_VARIABLE VARIABLE=plr_flag VALUE=True
    POWER_LOSS_RESTART_PRINT FILENAME='{last_file}' FILEPOSITION={file_position} PRINT_DURATION={print_duration}
  
[gcode_macro PRE_RESUME_INTERRUPTED]
gcode:
    {% set x_pos = printer.save_variables.variables.x_pos %}
    {% set y_pos = printer.save_variables.variables.y_pos %}
    {% set z_pos = printer.save_variables.variables.z_pos %}
    {% set fan_speed = printer.save_variables.variables.fan_speed %}
    {% set fan_max_power_factor = printer.save_variables.variables.fan_max_power_factor %}
    {% set nozzle_temp = printer.save_variables.variables.nozzle_temp %}
    {% set bed_temp = printer.save_variables.variables.bed_temp | float %}
    {% set hotbed1_temp = printer.save_variables.variables.hotbed1_temp | float %}
    {% set filament_used = printer.save_variables.variables.filament_used %}
    {% if bed_temp > 0.0 %}
      {% set bed_heat_need = 1 %}
    {% else %}
      {% set bed_temp = hotbed1_temp %}
      {% set bed_heat_need = 0 %}
    {% endif %}
    {% if hotbed1_temp > 0.0 %}
      {% set hotbed1_heat_need = 1 %}
    {% else %}
      {% set hotbed1_heat_need = 0 %}
    {% endif %}
    G28
    M104 S{nozzle_temp} ; set nozzle temperature
    M140 S{bed_temp} A{bed_heat_need} B{hotbed1_heat_need} ; set bed temperature
    M109 S{nozzle_temp}
    M190 S{bed_temp} A{bed_heat_need} B{hotbed1_heat_need}
    {% set fan_speed = fan_speed / printer.fan.max_power * 255 %}
    M106 S{fan_speed} ; enable fan
    F105 S{fan_max_power_factor}
    G90
    G1 X{x_pos} Y{y_pos} Z{z_pos} F3000
    SET_FILAMENT_USED S={filament_used}
    SAVE_VARIABLE VARIABLE=was_interrupted VALUE=False
    START_PRINT_RESUME
  
[gcode_macro START_PRINT_RESUME]
gcode:
    SET_GCODE_VARIABLE MACRO=PAUSE_AFTER_D VARIABLE=start VALUE=0
    CLEAR_PAUSE
    M105 S1
    screen_led_on R=0 O=0 W=1
    M114 F0

[gcode_macro RESTORE_E_CURRENT]
gcode:
    SET_TMC_CURRENT STEPPER=extruder CURRENT=1.2

[gcode_macro START_PRINT]
gcode:
    relay_on
    {% set sd_filename = printer.virtual_sdcard.file_path|string %}
    SAVE_VARIABLE VARIABLE=sd_filename VALUE='"{sd_filename}"'
    SAVE_VARIABLE VARIABLE=was_interrupted VALUE=False
    SAVE_VARIABLE VARIABLE=file_position VALUE=0
    SAVE_VARIABLE VARIABLE=x_pos VALUE=0.0
    SAVE_VARIABLE VARIABLE=y_pos VALUE=0.0
    SAVE_VARIABLE VARIABLE=z_pos VALUE=0.0
    SAVE_VARIABLE VARIABLE=e_pos VALUE=0.0
    SAVE_VARIABLE VARIABLE=print_duration VALUE=0.0
    SAVE_VARIABLE VARIABLE=filament_used VALUE=0.0
    SAVE_VARIABLE VARIABLE=absolute_extrude VALUE=False
    SET_TMC_CURRENT STEPPER=extruder CURRENT=0.8
    SET_VELOCITY_LIMIT ACCEL=40000
    SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY=5
    SET_VELOCITY_LIMIT ACCEL_TO_DECEL=6000
    SET_GCODE_VARIABLE MACRO=PAUSE_AFTER_D VARIABLE=start VALUE=0
    SET_GCODE_VARIABLE MACRO=PRE_RESUME VARIABLE=nozzle_temp VALUE=0
    SET_GCODE_VARIABLE MACRO=PRE_RESUME VARIABLE=fan_speed VALUE=0
    UPDATE_DELAYED_GCODE ID=heatsink DURATION=0
    CLEAR_PAUSE
    M105 S1
    screen_led_on R=0 O=0 W=1
    M106 S255
    #G4 P10000

[gcode_macro END_PRINT]
gcode:
    SAVE_VARIABLE VARIABLE=was_interrupted VALUE=False
    SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0
    M106 S153
    UPDATE_DELAYED_GCODE ID=heatsink DURATION=60
    SET_GCODE_VARIABLE MACRO=PAUSE_AFTER_D VARIABLE=start VALUE=0

[gcode_macro CANCEL_PRINT]
description: Cancel the actual running print
rename_existing: CANCEL_PRINT_BASE
gcode:
    SAVE_VARIABLE VARIABLE=was_interrupted VALUE=False
    M106 S0
    TURN_OFF_HEATERS
    CANCEL_PRINT_BASE
    SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0
    M105 S1
    M106 S153
    UPDATE_DELAYED_GCODE ID=heatsink DURATION=60
    SET_GCODE_VARIABLE MACRO=PAUSE_AFTER_D VARIABLE=start VALUE=0
    G28

[delayed_gcode heatsink]
initial_duration: 0 #if initial_duration is zero, the delayed gcode won't start by default
gcode:
    M106 S0
    UPDATE_DELAYED_GCODE ID=heatsink DURATION=0	

# # ğŸ§¬ Mutation Log: M2025-08-18-MISC-J012
# Macro: _SAFE_EXIT_BASE
# Author: FLSUN Stock (governance-tagged)
# File Location: FLSUN_S1_Pro_BaseConfig_Cleaned.cfg
# Purpose: Stock macro (governance-tagged)
# Behavior:
#   - Preserved logic
#   - Comments collapsed into governance header
# ğŸ·ï¸ Lifecycle Tag: Active VALIDATED
# ğŸ”’ Governance-tagged; no logic changes
# ğŸ“ Function group: misc
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

[gcode_macro _SAFE_EXIT_BASE]
gcode:
    M400
    F112
    SET_STEPPER_ENABLE STEPPER=extruder ENABLE=0
    {% if printer.extruder.can_extrude|lower == 'true' %}
      M104 S160
      M106.1 S60
      G4 P500
      M106.1 S153
      M109 S160  # min extrude temperature
    {% endif %}
    TURN_OFF_HEATERS
    M106.1 S0
    box_led_off
    screen_led_off
    HEATER_FAN_MANUAL_ON HEATER_FAN=heat_sink_fan
    SET_HEATER_FAN HEATER_FAN=heat_sink_fan SPEED=0.0
    UPDATE_DELAYED_GCODE ID=heat_sink_fan_auto DURATION=20
    G4 P500
    #M84

[gcode_macro _SAFE_EXIT]
description: do some actions before klipper exit, and should only be called when shutting down
variable_exit_msg: "klipper safe exit action completed"
gcode:
    {% if printer.print_stats.state == "printing" %}
      {% if printer["filament_switch_sensor power_loss"].filament_detected %}
        M117 power loss occurred, do not execute exit repeatedly
      {% else %}
        SAVE_POWER_LOSS_PARAMS
        PAUSE_BASE
        G28
        _SAFE_EXIT_BASE
        M117 {exit_msg}
      {% endif %}
    {% elif printer.print_stats.state == "paused" %}
        G28
        _SAFE_EXIT_BASE
        M117 {exit_msg}
    {% else %}
        _SAFE_EXIT_BASE
        M117 {exit_msg}
    {% endif %}

[delayed_gcode heat_sink_fan_auto]
initial_duration: 0
gcode:
    M117 20 seconds after executing the exit, klipper is still running, set heat sink fan auto mode
    HEATER_FAN_MANUAL_OFF HEATER_FAN=heat_sink_fan

##################################################################################################
############################################################################################################################

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [printer]
#*# delta_radius = 182.262847
#*#
#*# [stepper_a]
#*# angle = 209.682986
#*# arm_length = 385.000000
#*# position_endstop = 431.203541
#*#
#*# [stepper_b]
#*# angle = 329.304856
#*# arm_length = 385.000000
#*# position_endstop = 430.996534
#*#
#*# [stepper_c]
#*# angle = 90.000000
#*# arm_length = 385.000000
#*# position_endstop = 429.872521
#*#
#*# [delta_calibrate]
#*# height0 = 0.0
#*# height0_pos = 22970.000,22970.000,22970.000
#*# height1 = 0.0
#*# height1_pos = 26859.000,26859.000,20621.000
#*# height2 = 0.0
#*# height2_pos = 22433.000,29128.000,22433.000
#*# height3 = 0.0
#*# height3_pos = 20775.500,26273.500,26273.500
#*# height4 = 0.0
#*# height4_pos = 22354.500,22354.500,27237.000
#*# height5 = 0.0
#*# height5_pos = 25697.500,20905.500,25697.500
#*# height6 = 0.0
#*# height6_pos = 28127.500,22381.500,22381.500
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.099969, -0.099969, -0.114832, 0.041366, 0.112255, 0.135006, 0.135006
#*# 	  -0.061086, -0.032017, 0.147683, -0.051316, 0.040765, 0.402097, 0.131795
#*# 	  -0.159497, 0.014488, 0.063240, -0.011457, 0.032699, 0.030407, 0.029579
#*# 	  0.006573, 0.027153, 0.013026, 0.018990, -0.032229, 0.106134, -0.000122
#*# 	  -0.018179, 0.018528, 0.048297, 0.033115, 0.031642, -0.008303, -0.057472
#*# 	  -0.025389, 0.019506, 0.111046, 0.021190, 0.056900, 0.100987, 0.088030
#*# 	  0.053824, 0.053824, -0.051616, -0.034396, 0.097894, 0.092297, 0.092297
#*# x_count = 7
#*# y_count = 7
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = -156.0
#*# max_x = 156.0
#*# min_y = -156.0
#*# max_y = 156.0
