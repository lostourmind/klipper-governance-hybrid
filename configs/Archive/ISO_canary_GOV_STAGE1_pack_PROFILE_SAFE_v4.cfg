# ================================
# ISO Canary Stage1 Pack - PROFILE SAFE (v4)
# Defer-persistence aware + in-session hydrator
# ================================

[gcode_macro GOV_SET_MESH_PROFILE_CODE]
description: "Set numeric code for mesh profile name (1=governance, 2=cal1, 3=prod1)"
variable_code: 1
gcode:
    {% set code = params.CODE|int %}
    SET_GCODE_VARIABLE MACRO=GOV_SET_MESH_PROFILE_CODE VARIABLE=code VALUE={code}
    SAVE_VARIABLE VARIABLE=gov_mesh_profile_code VALUE={code}
    RESPOND MSG="GOV: mesh_profile_code set to {code}"

[gcode_macro GOV_MESH_SAVE_CURRENT]
description: "Save current mesh to mapped profile and set hydration flag (requires SAVE_CONFIG or RESTART to persist on this firmware)"
gcode:
    {% set code = printer.save_variables.variables.gov_mesh_profile_code|default(1)|int %}
    {% if code == 1 %}
        {% set profile = "governance" %}
    {% elif code == 2 %}
        {% set profile = "cal1" %}
    {% elif code == 3 %}
        {% set profile = "prod1" %}
    {% else %}
        {% set profile = "governance" %}
    {% endif %}
    RESPOND MSG="GOV: saving current mesh to {profile}"
    BED_MESH_PROFILE SAVE={profile}
    SAVE_VARIABLE VARIABLE=gov_default_mesh VALUE=1
    RESPOND MSG="GOV: hydration_flag set to 1 (persist on RESTART)"

[gcode_macro GOV_MESH_FLAGS_READ]
description: "Read back mesh profile code and hydration flag"
gcode:
    {% set code = printer.save_variables.variables.gov_mesh_profile_code|default(0)|int %}
    {% set flag = printer.save_variables.variables.gov_default_mesh|default(0)|int %}
    RESPOND MSG="GOV: mesh_profile_code={code}"
    RESPOND MSG="GOV: hydration_flag={flag}"

[gcode_macro GOV_MESH_SAVE_AND_COMMIT]
description: "Save mesh to mapped profile and persist via SAVE_CONFIG"
gcode:
    {% set code = printer.save_variables.variables.gov_mesh_profile_code|default(1)|int %}
    {% if code == 1 %}
        {% set profile = "governance" %}
    {% elif code == 2 %}
        {% set profile = "cal1" %}
    {% elif code == 3 %}
        {% set profile = "prod1" %}
    {% else %}
        {% set profile = "governance" %}
    {% endif %}
    RESPOND MSG="GOV: saving mesh to {profile} and committing to disk"
    BED_MESH_PROFILE SAVE={profile}
    SAVE_VARIABLE VARIABLE=gov_default_mesh VALUE=1
    SAVE_CONFIG

[gcode_macro GOV_HYDRATE_NOW]
description: "Load mapped mesh profile immediately (in-session)"
gcode:
    {% set code = printer.save_variables.variables.gov_mesh_profile_code|default(1)|int %}
    {% if code == 1 %}
        {% set profile = "governance" %}
    {% elif code == 2 %}
        {% set profile = "cal1" %}
    {% elif code == 3 %}
        {% set profile = "prod1" %}
    {% else %}
        {% set profile = "governance" %}
    {% endif %}
    RESPOND MSG="GOV: in-session hydration requested for {profile}"
    G4 P1000
    BED_MESH_PROFILE LOAD={profile}
    RESPOND MSG="GOV: in-session hydration complete for {profile}"

[delayed_gcode GOV_STARTUP_HYDRATE]
initial_duration: 2.0
gcode:
    RESPOND MSG="GOV: Startup hydration begin (MID=0)"
    {% if printer.configfile.settings.bed_mesh is defined %}
        {% set has_flag = printer.save_variables.variables.gov_default_mesh|default(0)|int %}
        {% set code = printer.save_variables.variables.gov_mesh_profile_code|default(1)|int %}
        {% if code == 1 %}
            {% set profile = "governance" %}
        {% elif code == 2 %}
            {% set profile = "cal1" %}
        {% elif code == 3 %}
            {% set profile = "prod1" %}
        {% else %}
            {% set profile = "governance" %}
        {% endif %}
        {% if has_flag == 1 %}
            RESPOND MSG="GOV: bed_mesh detected - loading profile {profile}"
            G4 P2000
            BED_MESH_PROFILE LOAD={profile}
            RESPOND MSG="GOV: mesh profile load requested ({profile})"
        {% else %}
            RESPOND MSG="GOV: bed_mesh configured - hydration_flag not set - skipped"
        {% endif %}
    {% else %}
        RESPOND MSG="GOV: bed_mesh not configured - hydration skipped"
    {% endif %}
    RESPOND MSG="GOV: Startup hydration complete"

[delayed_gcode GOV_DELTA_RISK_NOTE]
initial_duration: 1.0
gcode:
    RESPOND MSG="GOV: Risk Note (Delta): home plus probe init required before probing"

[gcode_macro GOV_ECHO]
description: "Emit standardized audit overlays (numeric MUTATION_ID only)"
gcode:
    {% set mid = params.MUTATION_ID|default(0)|int %}
    RESPOND MSG="GOV: Audit Echo (MID={mid})"
