# ================================
# ISO Canary Stage1 Pack - PROFILE SAFE (v2)
# Governance Macros for Klipper
# Fixes:
#  - Removed invalid variable_* from [delayed_gcode]
#  - Use SAVE_VARIABLE for restart-safe flags (gov_default_mesh, gov_mesh_profile_code)
#  - Guard hydration on bed_mesh presence
# ================================

[gcode_macro GOV_SET_MESH_PROFILE_CODE]
description: "Set numeric code for mesh profile name (1=governance, 2=cal1, 3=prod1)"
variable_code: 1
gcode:
    {% set code = params.CODE|int %}
    SET_GCODE_VARIABLE MACRO=GOV_SET_MESH_PROFILE_CODE VARIABLE=code VALUE={code}
    SAVE_VARIABLE VARIABLE=gov_mesh_profile_code VALUE={code}
    RESPOND MSG="GOV: Mesh profile code set to {code}"

[gcode_macro GOV_MESH_SAVE_CURRENT]
description: "Save current mesh into profile mapped by GOV_SET_MESH_PROFILE_CODE and set hydration flag"
gcode:
    {% set code = printer.save_variables.variables.gov_mesh_profile_code|default(1)|int %}
    {% if code == 1 %}
        {% set profile = "governance" %}
    {% elif code == 2 %}
        {% set profile = "cal1" %}
    {% elif code == 3 %}
        {% set profile = "prod1" %}
    {% else %}
        {% set profile = "governance" %}
    {% endif %}
    RESPOND MSG="GOV: Saving mesh to profile {profile}"
    BED_MESH_PROFILE SAVE={profile}
    SAVE_VARIABLE VARIABLE=gov_default_mesh VALUE=1
    RESPOND MSG="GOV: Hydration flag set (gov_default_mesh=1)"

[delayed_gcode GOV_STARTUP_HYDRATE]
initial_duration: 1.0
gcode:
    RESPOND MSG="GOV: Startup hydration begin (MID=0)"
    {% if printer.configfile.settings.bed_mesh is defined %}
        {% set has_flag = printer.save_variables.variables.gov_default_mesh|default(0)|int %}
        {% set code = printer.save_variables.variables.gov_mesh_profile_code|default(1)|int %}
        {% if code == 1 %}
            {% set profile = "governance" %}
        {% elif code == 2 %}
            {% set profile = "cal1" %}
        {% elif code == 3 %}
            {% set profile = "prod1" %}
        {% else %}
            {% set profile = "governance" %}
        {% endif %}
        {% if has_flag == 1 %}
            RESPOND MSG="GOV: bed_mesh detected - loading profile {profile}"
            G4 P2000
            BED_MESH_PROFILE LOAD={profile}
            RESPOND MSG="GOV: mesh profile load requested ({profile})"
        {% else %}
            RESPOND MSG="GOV: bed_mesh configured - hydration flag not set - skipped"
        {% endif %}
    {% else %}
        RESPOND MSG="GOV: bed_mesh not configured - hydration skipped"
    {% endif %}
    RESPOND MSG="GOV: Startup hydration complete"

[delayed_gcode GOV_DELTA_RISK_NOTE]
initial_duration: 1.0
gcode:
    RESPOND MSG="GOV: Risk Note (Delta): home plus probe init required before probing"

[gcode_macro GOV_ECHO]
description: "Emit standardized audit overlays (numeric MUTATION_ID only)"
gcode:
    {% set mid = params.MUTATION_ID|default(0)|int %}
    RESPOND MSG="GOV: Audit Echo (MID={mid})"

